# Project Context: Story Library

This document outlines the complete technical and functional specifications for the "Story Library" project. All code generated by the Gemini CLI must adhere to the principles and rules defined herein.

## 1. Project Vision & Core Objectives
The project vision is to create a web-based platform where users can read stories in multiple languages (initially Turkish and English) with paragraph-by-paragraph translations. The goal is to facilitate language learning through contextual reading.

**Core Objectives:**
- Provide an intuitive reading experience with flexible language display modes.
- Enable editors to efficiently manage and publish bilingual content.
- Track user reading progress and story completion.
- Support scalable content management with a dynamic categorization and tagging system.

## 2. Technology Stack
- **Backend:** Node.js, TypeScript, Express.js
- **Database ORM:** Prisma
- **Frontend:** Nuxt.js 3 (with Vue 3)
- **UI Framework:** Tailwind CSS
- **Database:** PostgreSQL
- **Authentication:** JWT via Passport.js

## 3. Finalized Technical Rules & Logic

### Roles & Permissions
- **USER:** Can only read stories with `status: 'PUBLISHED'` and `deleted_at: null`.
- **EDITOR:** Has all USER permissions, plus: can create new stories, update their own stories, and change the `status` (`DRAFT`, `PUBLISHED`) of their own stories. They cannot modify stories created by other editors.
- **ADMIN:** Has all EDITOR permissions, plus: can update and soft-delete any story (regardless of the owner), and manage soft-deleted content.

### Business Rules
- A story must belong to at least one category.

### Statistics Calculation Logic
- This logic must be executed on the backend whenever a story is created or updated.
- `word_count` and `char_count` should be calculated for each language within the story's content.
- `estimated_reading_time` (in minutes) must be calculated using the formula: `word_count / 200`.
- The results should be stored in the `statistics` JSON field of the `Story` table.

### Rating Calculation Logic
- When a user submits a rating via the API, the `average_rating` and `rating_count` fields in the `Story` table must be updated using the following formula: `new_average = ((old_average * old_rating_count) + new_rating) / (old_rating_count + 1)`.

### Deletion Process (Soft Delete)
- All delete operations must be **soft deletes**.
- The `Story` table includes a `deleted_at` field, which is `null` for active records. When a story is deleted, this field should be updated with the current timestamp.
- All standard data retrieval queries (e.g., fetching a list of stories for users) must include the condition `WHERE deleted_at IS NULL`.

### Admin - Deleted Content Management
- The Admin role requires specific API endpoints to manage soft-deleted content:
    - `GET /api/admin/stories/deleted`: Lists all soft-deleted stories.
    - `POST /api/admin/stories/:id/restore`: Restores a soft-deleted story by setting its `deleted_at` field back to `null`.
    - `DELETE /api/admin/stories/:id/permanent`: Permanently removes a story from the database. This is a hard delete and should be used with caution.

### Standard API Error Format
- All API errors must be returned in the following standard JSON format:
    ```json
    {
      "error": {
        "message": "A user-friendly error message.",
        "code": "ERROR_CODE_STRING",
        "statusCode": 4xx
      }
    }
    ```

## 4. Database Schema (Prisma)
```prisma
// This is your Prisma schema file.
// All tables and relations for the Story Library project are defined here.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  EDITOR
  ADMIN
}

enum StoryStatus {
  DRAFT
  PUBLISHED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  password_hash String
  role          Role      @default(USER)
  profile       Json?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  ratings       UserStoryRating[]
  progress      UserReadingProgress[]
  author        Author? // A user can optionally be an author
}

model Story {
  id                  String           @id @default(uuid())
  title               Json // {"en": "Title", "tr": "Başlık"}
  short_description   Json // {"en": "Description", "tr": "Açıklama"}
  slug                String           @unique
  content             Json // {"en": ["p1", "p2"], "tr": ["p1", "p2"]}
  status              StoryStatus      @default(DRAFT)
  source_info         Json? // {"site_name": "...", "url": "..."}
  statistics          Json? // {"word_count": {"en": 150, "tr": 140}, ...}
  editor_rating       Decimal?         @db.Decimal(3, 2)
  average_rating      Decimal          @default(0) @db.Decimal(3, 2)
  rating_count        Int              @default(0)
  created_at          DateTime         @default(now())
  updated_at          DateTime         @updatedAt
  published_at        DateTime?
  deleted_at          DateTime? // For Soft Delete

  authors      StoryAuthor[]
  ratings      UserStoryRating[]
  categories   StoryCategory[]
  tags         StoryTag[]
  series       StorySeries[]
  progress     UserReadingProgress[]
}

model Author {
  id         String        @id @default(uuid())
  name       String
  bio        Json?
  slug       String        @unique
  created_at DateTime      @default(now())
  stories    StoryAuthor[]
  user       User?         @relation(fields: [userId], references: [id])
  userId     String?       @unique // Each author is one user
}

model Category {
  id          String          @id @default(uuid())
  name        Json
  description Json?
  slug        String          @unique
  created_at  DateTime        @default(now())
  stories     StoryCategory[]
}

model Tag {
  id         String     @id @default(uuid())
  name       Json
  slug       String     @unique
  color      String?
  created_at DateTime   @default(now())
  stories    StoryTag[]
}

model Series {
  id          String        @id @default(uuid())
  name        Json
  description Json?
  slug        String        @unique
  created_at  DateTime      @default(now())
  stories     StorySeries[]
}

// --- Relationship Tables ---

model StoryAuthor {
  story    Story  @relation(fields: [story_id], references: [id])
  story_id String
  author   Author @relation(fields: [author_id], references: [id])
  author_id String
  role     String @default("author") // e.g., 'author', 'translator'

  @@id([story_id, author_id])
}

model StoryCategory {
  story       Story    @relation(fields: [story_id], references: [id])
  story_id    String
  category    Category @relation(fields: [category_id], references: [id])
  category_id String

  @@id([story_id, category_id])
}

model StoryTag {
  story    Story  @relation(fields: [story_id], references: [id])
  story_id String
  tag      Tag    @relation(fields: [tag_id], references: [id])
  tag_id   String

  @@id([story_id, tag_id])
}

model StorySeries {
  story           Story  @relation(fields: [story_id], references: [id])
  story_id        String
  series          Series @relation(fields: [series_id], references: [id])
  series_id       String
  order_in_series Int?

  @@id([story_id, series_id])
}

model UserStoryRating {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [user_id], references: [id])
  user_id    String
  story      Story    @relation(fields: [story_id], references: [id])
  story_id   String
  rating     Decimal  @db.Decimal(3, 2)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([user_id, story_id])
}

model UserReadingProgress {
  id             String    @id @default(uuid())
  user           User      @relation(fields: [user_id], references: [id])
  user_id        String
  story          Story     @relation(fields: [story_id], references: [id])
  story_id      String
  status         String // e.g., 'started', 'completed'
  last_paragraph Int?
  started_at     DateTime  @default(now())
  completed_at   DateTime?

  @@unique([user_id, story_id])
}
```

## 5. API Specifications

All API endpoints are prefixed with `/api`.

### Authentication & User Management (`/api/auth`)
- `POST /api/auth/register`: Register a new user.
- `POST /api/auth/login`: Log in a user and set an `httpOnly` JWT cookie.
- `GET /api/auth/me`: Get the currently authenticated user's details (protected).
- `POST /api/auth/logout`: Log out a user by clearing the JWT cookie.
- `GET /api/auth/users/:userId/stories`: Get stories created by a specific user (protected).
- `PUT /api/auth/me/profile`: Update the authenticated user's profile (protected).

### Story Management (`/api/stories`)
- `POST /api/stories`: Create a new story (protected: EDITOR, ADMIN).
- `GET /api/stories`: List all published stories.
- `GET /api/stories/:slug`: Get a single published story by slug.
- `GET /api/stories/id/:id`: Get a single story by ID.
- `PUT /api/stories/:id`: Update an existing story (protected: EDITOR for own stories, ADMIN for any).
- `DELETE /api/stories/:id`: Soft delete a story (protected: ADMIN).

### Story Rating (`/api/stories`)
- `POST /api/stories/:id/rate`: Submit or update a rating for a story (protected).

### Author Management (`/api/authors`)
- `GET /api/authors`: List all authors.
- `GET /api/authors/:id`: Get a single author by ID.
- `POST /api/authors`: Create a new author (protected: ADMIN).
- `PUT /api/authors/:id`: Update an existing author (protected: ADMIN).
- `DELETE /api/authors/:id`: Delete an author (protected: ADMIN).
- `GET /api/authors/:slug/stories`: Get stories by author slug.

### Category Management (`/api/categories`)
- `GET /api/categories`: List all categories.
- `GET /api/categories/:id`: Get a single category by ID.
- `POST /api/categories`: Create a new category (protected: ADMIN).
- `PUT /api/categories/:id`: Update an existing category (protected: ADMIN).
- `DELETE /api/categories/:id`: Delete a category (protected: ADMIN).
- `GET /api/categories/:slug/stories`: Get stories by category slug.

### Tag Management (`/api/tags`)
- `GET /api/tags`: List all tags.
- `GET /api/tags/:id`: Get a single tag by ID.
- `POST /api/tags`: Create a new tag (protected: ADMIN).
- `PUT /api/tags/:id`: Update an existing tag (protected: ADMIN).
- `DELETE /api/tags/:id`: Delete a tag (protected: ADMIN).

### Series Management (`/api/series`)
- `GET /api/series`: List all series.
- `GET /api/series/:id`: Get a single series by ID.
- `POST /api/series`: Create a new series (protected: ADMIN).
- `PUT /api/series/:id`: Update an existing series (protected: ADMIN).
- `DELETE /api/series/:id`: Delete a series (protected: ADMIN).
- `GET /api/series/:slug/stories`: Get stories by series slug.

### Admin-Specific Management (`/api/admin`)
- `GET /api/admin/stories/deleted`: Lists all soft-deleted stories (protected: ADMIN).
- `POST /api/admin/stories/:id/restore`: Restores a soft-deleted story (protected: ADMIN).
- `DELETE /api/admin/stories/:id/permanent`: Permanently removes a story (protected: ADMIN).

## 6. Frontend Structure

### Pages
- `/`: Home page, lists all published stories with author and category links.
- `/about`: About Us page.
- `/login`: User login page.
- `/register`: User registration page.
- `/profile`: User profile page, allows updating profile information.
- `/story/[slug]`: Story detail page, displays content with language switching, rating component, and metadata links (authors, categories, series).
- `/authors`: Index page for authors, lists all authors.
- `/authors/[slug]`: Author detail page, lists stories by a specific author.
- `/categories`: Index page for categories, lists all categories.
- `/categories/[slug]`: Category detail page, lists stories within a specific category.
- `/series`: Index page for series, lists all series.
- `/series/[slug]`: Series detail page, lists stories within a specific series.
- `/editor/create`: Page for creating new stories (protected: EDITOR, ADMIN).
- `/editor/my-stories`: Dashboard for editors to manage their own stories (protected: EDITOR, ADMIN).
- `/editor/edit/[id]`: Page for editing an existing story (protected: EDITOR for own stories, ADMIN for any).
- `/admin/stories`: Admin dashboard for managing all stories, including soft-deleted ones (protected: ADMIN).
- `/admin/categories`: Admin page for managing categories (create, list, edit, delete) (protected: ADMIN).
- `/admin/authors`: Admin page for managing authors (create, list, edit, delete, link to user ID) (protected: ADMIN).
- `/admin/series`: Admin page for managing series (create, list, edit, delete) (protected: ADMIN).
- `/admin/tags`: Admin page for managing tags (create, list, edit, delete) (protected: ADMIN).

### Layouts
- `default.vue`: Main layout for the application. Includes a header with site title and navigation, a main content slot, and a footer. The navigation features dropdown menus for:
    - **Admin Panel:** (visible to ADMIN only) Contains links to Admin Dashboard, Admin Categories, Admin Authors, Admin Series, Admin Tags.
    - **Profile/User Menu:** (visible when logged in) Contains links to Profile, Create Story, My Stories, and Logout.

### Composables
- `useAuth.ts`: Manages user authentication state globally using `useState`. Provides `login`, `register`, `logout`, and `fetchUser` functions.
